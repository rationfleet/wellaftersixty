<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <title>WellAfterSixty Admin</title>
</head>

<body>
    <!-- Include the Decap CMS script -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    <script>
        // AUTH MESSAGE HANDLER
        // Handles both success and error cases from OAuth popup
        window.addEventListener("message", async (e) => {
            if (typeof e.data !== "string") return;

            // Handle authentication errors
            if (e.data.startsWith("authorization:github:error:")) {
                console.error("GitHub auth error received:", e.data);
                try {
                    const errorData = JSON.parse(e.data.replace("authorization:github:error:", ""));
                    alert("GitHub Login Failed:\n\n" + (errorData.error_description || errorData.error || "Unknown error") + "\n\nNote: You must have a GitHub account with access to the repository to use this CMS.");
                } catch (err) {
                    alert("GitHub login failed. Please make sure you have a GitHub account and try again.");
                }
                return;
            }

            // Handle successful authentication
            if (e.data.startsWith("authorization:github:success:")) {
                console.log("Token received! Attempting manual login injection...");

                try {
                    const data = JSON.parse(e.data.replace("authorization:github:success:", ""));
                    const token = data.token;

                    if (!token) throw new Error("No token found in message");

                    // 1. Fetch User Data from GitHub
                    const userResp = await fetch("https://api.github.com/user", {
                        headers: { Authorization: `token ${token}` }
                    });

                    if (!userResp.ok) throw new Error("Failed to fetch user data from GitHub");
                    const user = await userResp.json();

                    // 2. Construct the CMS User Object
                    const cmsUser = {
                        backendName: "github",
                        token: token,
                        name: user.name || user.login,
                        login: user.login,
                        avatar_url: user.avatar_url,
                        email: user.email
                    };

                    console.log("User data fetched. Saving to storage...", cmsUser);

                    // 3. Save to LocalStorage (Try both legacy and new keys)
                    const jsonUser = JSON.stringify(cmsUser);
                    localStorage.setItem("netlify-cms-user", jsonUser);
                    localStorage.setItem("decap-cms-user", jsonUser);

                    // 4. Force Reload to Enter Dashboard
                    console.log("Login injected. Reloading...");
                    window.location.reload();

                } catch (err) {
                    console.error("Manual login failed:", err);
                    alert("Login failed: " + err.message + "\n\nPlease try again.");
                }
            }
        });

        // Ensure button is enabled so you can click it to trigger the flow
        setInterval(() => {
            const btn = document.querySelector("button");
            if (btn && btn.disabled) {
                btn.removeAttribute("disabled");
                btn.classList.remove("disabled");
                btn.disabled = false;
            }
        }, 500);
    </script>
</body>

</html>